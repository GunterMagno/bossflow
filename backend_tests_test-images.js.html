<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>backend/tests/test-images.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <li class="nav-link nav-home-link"><a href="index.html">Home</a></li><li class="nav-heading"><a href="global.html">Globals</a></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#AbilityNode">AbilityNode</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#ActionIcon">ActionIcon</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#ActionNode">ActionNode</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#ACTIVITY_STORAGE_PREFIX">ACTIVITY_STORAGE_PREFIX</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#ACTIVITY_TYPES">ACTIVITY_TYPES</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#allowedOrigins">allowedOrigins</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#api">api</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#App">App</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#auth">auth</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#AuthProvider">AuthProvider</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#authService">authService</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#baseURL">baseURL</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#clearActivities">clearActivities</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#Community">Community</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#COMPATIBLE_VERSIONS">COMPATIBLE_VERSIONS</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#ConfirmDialog">ConfirmDialog</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#ConfirmModal">ConfirmModal</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#connectDB">connectDB</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#CookieBanner">CookieBanner</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#CookiesPolicy">CookiesPolicy</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#createDiagram">createDiagram</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#createTransporter">createTransporter</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#CURRENT_VERSION">CURRENT_VERSION</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#CustomEdge">CustomEdge</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#Dashboard">Dashboard</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#DecisionIcon">DecisionIcon</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#DecisionNode">DecisionNode</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#DEFAULT_TEMPLATES">DEFAULT_TEMPLATES</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#deleteAccount">deleteAccount</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#deleteDiagram">deleteDiagram</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#deleteImage">deleteImage</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#deleteTemplate">deleteTemplate</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#DiagramCard">DiagramCard</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#DiagramList">DiagramList</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#Editor">Editor</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#EditorSidebar">EditorSidebar</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#EffectIcon">EffectIcon</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#EffectNode">EffectNode</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#EndNode">EndNode</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#ExportHandler">ExportHandler</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#ExportModal">ExportModal</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#exportUserData">exportUserData</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#FlowMap">FlowMap</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#Footer">Footer</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#formatRelativeDate">formatRelativeDate</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#getActivities">getActivities</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#getCurrentUserId">getCurrentUserId</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#getDiagramById">getDiagramById</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#getDiagrams">getDiagrams</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#getFormattedActivities">getFormattedActivities</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#getProfile">getProfile</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#getStats">getStats</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#getStorageKey">getStorageKey</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#getTemplates">getTemplates</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#Handles">Handles</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#healthCheck">healthCheck</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#Home">Home</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#http">http</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#ImageNode">ImageNode</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#ImportJSON">ImportJSON</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#isValidJSONFile">isValidJSONFile</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#isVersionCompatible">isVersionCompatible</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#Layout">Layout</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#Login">Login</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#login">login</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#logout">logout</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#MobileNodePanel">MobileNodePanel</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#mongoose">mongoose</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#Navbar">Navbar</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#NewDiagramModal">NewDiagramModal</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#NewTemplateModal">NewTemplateModal</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#NodeDescriptionPopup">NodeDescriptionPopup</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#NodeEditModal">NodeEditModal</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#NodeTitle">NodeTitle</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#NotFound">NotFound</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#PhaseIcon">PhaseIcon</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#PhaseNode">PhaseNode</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#PositionNode">PositionNode</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#PrivacyPolicy">PrivacyPolicy</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#PrivateRoute">PrivateRoute</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#Profile">Profile</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#Register">Register</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#register">register</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#registerActivity">registerActivity</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#sendVerificationEmail">sendVerificationEmail</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#sendWelcomeEmail">sendWelcomeEmail</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#Sidebar">Sidebar</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#StartEndIcon">StartEndIcon</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#StartNode">StartNode</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#startServer">startServer</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#Status">Status</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#TemplateCard">TemplateCard</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#TemplateList">TemplateList</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#Templates">Templates</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#TermsOfUse">TermsOfUse</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#TimerNode">TimerNode</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#Toast">Toast</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#ToastProvider">ToastProvider</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#Toolbar">Toolbar</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#updateDiagram">updateDiagram</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#updateProfile">updateProfile</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#uploadImage">uploadImage</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#UploadImageModal">UploadImageModal</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#useAuth">useAuth</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#useExportDiagram">useExportDiagram</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#useHealthCheck">useHealthCheck</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#useRecentNodes">useRecentNodes</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#useToast">useToast</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#validateDiagramStructure">validateDiagramStructure</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#validateEdge">validateEdge</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#validateEdges">validateEdges</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#validateImageMetadata">validateImageMetadata</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#validateImageUrl">validateImageUrl</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#validateJSONStructure">validateJSONStructure</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#validateNode">validateNode</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#validateNodes">validateNodes</a></span></li>
</nav>

<div id="main">
    
    <h1 class="page-title">backend/tests/test-images.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * Tests to validate the image schema in Diagrams and Nodes
 */

const http = require('http');

// Helper to register a user and obtain a token
function registerAndLogin() {
  return new Promise((resolve, reject) => {
    const timestamp = Date.now();
    const userData = {
      username: `imageuser${timestamp}`,
      email: `image${timestamp}@example.com`,
      password: 'password123'
    };

    const registerData = JSON.stringify(userData);
    const registerOptions = {
      hostname: 'localhost',
      port: 5000,
      path: '/api/auth/register',
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Content-Length': Buffer.byteLength(registerData)
      }
    };

    const registerReq = http.request(registerOptions, (res) => {
      let responseData = '';
      res.on('data', (chunk) => { responseData += chunk; });
      res.on('end', () => {
        try {
          const response = JSON.parse(responseData);
                    if (response.token) {
                        resolve(response.token);
                    } else {
                        reject('Could not obtain token');
                    }
                } catch (error) {
                    reject('Error parsing response: ' + error.message);
        }
      });
    });

    registerReq.on('error', reject);
    registerReq.write(registerData);
    registerReq.end();
  });
}

// Test to create a diagram with images
function testCreateDiagramWithImages(testName, diagramData, token, expectedStatus) {
  return new Promise((resolve, reject) => {
    const data = JSON.stringify(diagramData);

    const options = {
      hostname: 'localhost',
      port: 5000,
      path: '/api/diagrams',
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Content-Length': Buffer.byteLength(data),
        'Authorization': `Bearer ${token}`
      }
    };

    const req = http.request(options, (res) => {
      let responseData = '';
      
      res.on('data', (chunk) => {
        responseData += chunk;
      });
      
      res.on('end', () => {
        const passed = res.statusCode === expectedStatus;
        let parsedData = null;
        try {
          parsedData = JSON.parse(responseData);
        } catch (e) {}
        resolve({ testName, passed, status: res.statusCode, expectedStatus, data: parsedData });
      });
    });

    req.on('error', (error) => {
      reject({ testName, passed: false, error: error.message });
    });

    req.write(data);
    req.end();
  });
}

// Tests
async function runTests() {
    const results = [];

    try {
        const authToken = await registerAndLogin();
        const timestamp = Date.now();

        // Test 1: Create diagram with images in the diagram
        const createWithImages = await testCreateDiagramWithImages(
            'Create diagram with images',
            {
                title: `Diagram with Images ${timestamp}`,
                description: 'Image test',
                images: [
                    {
                        filename: 'background.png',
                        url: '/uploads/diagrams/bg.png',
                        mimeType: 'image/png',
                        size: 204800
                    },
                    {
                        filename: 'logo.webp',
                        url: '/uploads/diagrams/logo.webp',
                        mimeType: 'image/webp',
                        size: 51200
                    }
                ],
                nodes: [],
                edges: []
            },
            authToken,
            201
        );
        results.push(createWithImages);

        // Verify diagram images were saved correctly
        if (createWithImages.passed &amp;&amp; createWithImages.data &amp;&amp; createWithImages.data.diagram) {
            const diagram = createWithImages.data.diagram;
            const imagesValid = diagram.images &amp;&amp; 
                              diagram.images.length === 2 &amp;&amp;
                              diagram.images[0].filename === 'background.png' &amp;&amp;
                              diagram.images[1].mimeType === 'image/webp';
            
            results.push({
                testName: 'Verify saved diagram images',
                passed: imagesValid,
                status: imagesValid ? 200 : 'FAIL',
                expectedStatus: 200,
                response: !imagesValid ? JSON.stringify(diagram.images) : undefined
            });
        } else {
            results.push({
                testName: 'Verify saved diagram images',
                passed: false,
                status: 'FAIL',
                expectedStatus: 200,
                error: 'Creation test failed or did not return data'
            });
        }

        // Test 2: Create diagram with a node that has an image
        const createWithNodeImage = await testCreateDiagramWithImages(
            'Create diagram with node image',
            {
                title: `Diagram Node Image ${timestamp}`,
                description: 'Node image test',
                nodes: [
                    {
                        id: 'node-1',
                        type: 'customNode',
                        position: { x: 100, y: 100 },
                        data: { label: 'Node with image' },
                        image: {
                            filename: 'node-icon.png',
                            url: '/uploads/nodes/icon.png',
                            mimeType: 'image/png',
                            size: 15360
                        }
                    }
                ],
                edges: []
            },
            authToken,
            201
        );
        results.push(createWithNodeImage);

        // Verify that the node image was saved
        if (createWithNodeImage.passed &amp;&amp; createWithNodeImage.data &amp;&amp; createWithNodeImage.data.diagram) {
            const diagram = createWithNodeImage.data.diagram;
            const nodeImageValid = diagram.nodes &amp;&amp;
                                 diagram.nodes.length === 1 &amp;&amp;
                                 diagram.nodes[0].image &amp;&amp;
                                 diagram.nodes[0].image.filename === 'node-icon.png' &amp;&amp;
                                 diagram.nodes[0].image.mimeType === 'image/png';
            
            results.push({
                testName: 'Verify node image saved',
                passed: nodeImageValid,
                status: nodeImageValid ? 200 : 'FAIL',
                expectedStatus: 200,
                response: !nodeImageValid ? JSON.stringify(diagram.nodes[0]) : undefined
            });
        } else {
            results.push({
                testName: 'Verify node image saved',
                passed: false,
                status: 'FAIL',
                expectedStatus: 200,
                error: 'Creation test failed or did not return data'
            });
        }

        // Test 3: Reject invalid mimeType
        const invalidMimeType = await testCreateDiagramWithImages(
            'Reject invalid mimeType',
            {
                title: `Diagram Invalid MimeType ${timestamp}`,
                images: [
                    {
                        filename: 'document.pdf',
                        url: '/uploads/doc.pdf',
                        mimeType: 'application/pdf', // No permitido
                        size: 50000
                    }
                ],
                nodes: [],
                edges: []
            },
            authToken,
            400
        );
        results.push(invalidMimeType);

        // Test 4: Reject excessive size
        const invalidSize = await testCreateDiagramWithImages(
            'Reject excessive size (>5MB)',
            {
                title: `Diagram Excessive Size ${timestamp}`,
                images: [
                    {
                        filename: 'large-image.jpg',
                        url: '/uploads/large.jpg',
                        mimeType: 'image/jpeg',
                        size: 6 * 1024 * 1024 // 6MB, excede límite
                    }
                ],
                nodes: [],
                edges: []
            },
            authToken,
            400
        );
        results.push(invalidSize);

        // Test 5: Reject more than 10 images
        const tooManyImages = [];
        for (let i = 0; i &lt; 11; i++) {
            tooManyImages.push({
                filename: `image-${i}.jpg`,
                url: `/uploads/image-${i}.jpg`,
                mimeType: 'image/jpeg',
                size: 10240
            });
        }

        const exceedLimit = await testCreateDiagramWithImages(
            'Reject more than 10 images',
            {
                title: `Many Images Diagram ${timestamp}`,
                images: tooManyImages,
                nodes: [],
                edges: []
            },
            authToken,
            400
        );
        results.push(exceedLimit);

        // Test 6: Validate all allowed MIME types
        const validMimeTypes = await testCreateDiagramWithImages(
            'Accept all valid MIME types',
            {
                title: `Valid MIME Diagram ${timestamp}`,
                images: [
                    {
                        filename: 'img1.jpeg',
                        url: '/uploads/img1.jpeg',
                        mimeType: 'image/jpeg',
                        size: 10000
                    },
                    {
                        filename: 'img2.png',
                        url: '/uploads/img2.png',
                        mimeType: 'image/png',
                        size: 10000
                    },
                    {
                        filename: 'img3.gif',
                        url: '/uploads/img3.gif',
                        mimeType: 'image/gif',
                        size: 10000
                    },
                    {
                        filename: 'img4.webp',
                        url: '/uploads/img4.webp',
                        mimeType: 'image/webp',
                        size: 10000
                    }
                ],
                nodes: [],
                edges: []
            },
            authToken,
            201
        );
        results.push(validMimeTypes);

        // Test 7: Diagram with combined nodes and images
        const combinedTest = await testCreateDiagramWithImages(
            'Create diagram with images and nodes with images',
            {
                title: `Complete Diagram ${timestamp}`,
                images: [
                    {
                        filename: 'bg.jpg',
                        url: '/uploads/bg.jpg',
                        mimeType: 'image/jpeg',
                        size: 50000
                    }
                ],
                nodes: [
                    {
                        id: 'n1',
                        type: 'input',
                        position: { x: 0, y: 0 },
                        data: { label: 'Start' },
                        image: {
                            filename: 'start.png',
                            url: '/uploads/start.png',
                            mimeType: 'image/png',
                            size: 5000
                        }
                    },
                    {
                        id: 'n2',
                        type: 'output',
                        position: { x: 200, y: 200 },
                        data: { label: 'End' }
                        // This node does NOT have an image (optional)
                    }
                ],
                edges: [
                    { id: 'e1', source: 'n1', target: 'n2' }
                ]
            },
            authToken,
            201
        );
        results.push(combinedTest);

        // Verify complete structure
        if (combinedTest.passed &amp;&amp; combinedTest.data &amp;&amp; combinedTest.data.diagram) {
            const diagram = combinedTest.data.diagram;
            const completeValid = diagram.images &amp;&amp; diagram.images.length === 1 &amp;&amp;
                                diagram.nodes &amp;&amp; diagram.nodes.length === 2 &amp;&amp;
                                diagram.nodes[0].image &amp;&amp; diagram.nodes[0].image.filename === 'start.png' &amp;&amp;
                                !diagram.nodes[1].image &amp;&amp; // The second node does NOT have an image
                                diagram.edges &amp;&amp; diagram.edges.length === 1;
            
            results.push({
                testName: 'Verify complete structure with images',
                passed: completeValid,
                status: completeValid ? 200 : 'FAIL',
                expectedStatus: 200,
                response: !completeValid ? JSON.stringify({
                    imagesCount: diagram.images?.length,
                    nodesCount: diagram.nodes?.length,
                    node0HasImage: !!diagram.nodes?.[0]?.image,
                    node1HasImage: !!diagram.nodes?.[1]?.image,
                    edgesCount: diagram.edges?.length
                }) : undefined
            });
        } else {
            results.push({
                testName: 'Verify complete structure with images',
                passed: false,
                status: 'FAIL',
                expectedStatus: 200,
                error: 'El test de creación falló o no retornó datos'
            });
        }

    } catch (error) {
        results.push({ testName: 'Setup error', passed: false, error: error.message });
    }

    return results;
}

// Run tests if this is the main module
if (require.main === module) {
    runTests();
}

module.exports = { runTests };
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.7</a> on Thu Feb 12 2026 09:23:14 GMT+0000 (Coordinated Universal Time) using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
